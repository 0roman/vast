name: 'VAST Changelog'
on:
  pull_request:

jobs:
  update:
    name: 'Update'
    runs-on: ubuntu-20.04
    container: debian:buster-backports
    steps:
      - name: 'Install Git'
        run: |
          apt-get update
          apt-get -y install git
      - name: 'Checkout'
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          submodules: 'recursive'
      - name: 'Detect Changes in CHANGELOG.md'
        run: |
          alias is_unchanged="git diff --exit-code $(git merge-base 'origin/${{ github.event.pull_request.base.ref }}' HEAD) --"
          if ! is_unchanged CHANGELOG.md \
            && is_unchanged cmake/VASTVersionFallback.cmake; then
            echo 'Error: CHANGELOG.md must not be modified in non-release PRs'
            exit 1
          elif is_unchanged CHANGELOG.md \
            && ! is_unchanged cmake/VASTVersionFallback.cmake; then
            echo 'Error: CHANGELOG.md must be modified in release PRs'
            exit 1
          fi
      - name: 'Install Dependencies'
        run: |
          apt-get -y install libsnappy-dev libbrotli-dev zlib1g-dev wget \
            liblz4-dev libzstd-dev ninja-build libpcap-dev libssl-dev \
            libbenchmark-dev libflatbuffers-dev  flatbuffers-compiler-dev \
            libyaml-cpp-dev libsimdjson-dev gnupg2 gcc-8 g++-8 python3 \
            python3-pip python3-venv jq software-properties-common
          apt-get -y -t buster-backports install libspdlog-dev libfmt-dev
          python3 -m pip install --upgrade pip
          python3 -m pip install --upgrade cmake
      - name: 'Configure Build'
        env:
          CC: gcc-8
          CXX: g++-8
        run: |
          ./configure --with-bundled-caf --without-arrow
      - name: 'Update CHANGELOG.md'
        run: |
          cmake --build build --target update-changelog
